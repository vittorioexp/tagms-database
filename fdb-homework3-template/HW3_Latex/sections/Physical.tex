\section{Physical Schema}
\textcolor{red}{[Report SQL statements for the database creation]}

-- Database Creation
\begin{lstlisting}[
language=SQL,
keywordstyle=\color{blue},
stringstyle=\color{mauve},
showstringspaces=false,
basicstyle=\ttfamily\footnotesize]

-- Database Creation
CREATE DATABASE tagmsdb OWNER admin ENCODING = 'UTF8';

-- Create new Schema (you can use the public schema without creating a new one, if you want)
DROP SCHEMA IF EXISTS Tagms CASCADE;
CREATE SCHEMA Tagms;

-- Create new domains
CREATE DOMAIN Tagms.emailaddress AS VARCHAR(255)
CONSTRAINT properemail CHECK (VALUE ~ '^[A-Za-z0-9._%]+@[A-Za-z0-9.]+[.][A-Za-z]+$');

-- checks for the italian number structure w/ or w/o prefix
CREATE DOMAIN Tagms.phonenumber AS VARCHAR(17)
CONSTRAINT properphonenumber CHECK (VALUE ~ '^(\((00|\+)39\)|(00|\+)39)?3\d{9}$');

CREATE DOMAIN Tagms.vatnumber AS CHAR(11)
CONSTRAINT properVAT CHECK (VALUE ~ '^[0-9]{11}$');

CREATE DOMAIN Tagms.taxnumber AS CHAR(16)
CONSTRAINT propertaxnumber CHECK (VALUE ~ '^[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]$' );

CREATE DOMAIN Tagms.price AS NUMERIC(9, 3)
CONSTRAINT properprice NOT NULL CHECK (VALUE > 0.0);

CREATE DOMAIN Tagms.quantity AS INTEGER
CONSTRAINT properquantity NOT NULL CHECK (VALUE >= 1);

CREATE DOMAIN Tagms.dimension AS INTEGER
CONSTRAINT properdimension NOT NULL CHECK (VALUE > 0);

CREATE DOMAIN Tagms.percentage AS DECIMAL(4,1)
CONSTRAINT properpercentage CHECK (VALUE >= 0 and VALUE <= 100);

CREATE DOMAIN Tagms.tracknum AS VARCHAR(30)
CONSTRAINT propertracknum CHECK(VALUE ~ '[A-Za-z0-9]');

-- Table Creation (create tables in the correct order, i.e. use FKeys only referring to already created tables)

CREATE TABLE Tagms.product\_category (
product\_category\_id SMALLSERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500)
);

CREATE TABLE Tagms.item\_category (
item\_category\_id SMALLSERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500)
);

CREATE TABLE Tagms.package\_category (
package\_category\_id SMALLSERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500)
);

CREATE TABLE Tagms.product (
product\_id SERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500),
production\_cost Tagms.price,
price\_increase Numeric(3, 1) NOT NULL CHECK (price\_increase >= 1),
volume Tagms.dimension,
net\_weight Tagms.dimension,
package\_weight Tagms.dimension,
nutritional\_facts VARCHAR(500) NOT NULL,
product\_category\_id SMALLINT NOT NULL,
FOREIGN KEY (product\_category\_id) REFERENCES Tagms.product\_category(product\_category\_id)
);

CREATE TABLE Tagms.item (
item\_id SERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500),
quantity Tagms.quantity,
minimum\_quantity Tagms.quantity,
item\_category\_id SMALLINT NOT NULL,
FOREIGN KEY (item\_category\_id) REFERENCES Tagms.item\_category(item\_category\_id)
);

CREATE TABLE Tagms.package (
package\_id SMALLSERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500),
weight Tagms.dimension,
height Tagms.dimension,
width Tagms.dimension,
depth Tagms.dimension,
package\_category\_id SMALLINT NOT NULL,
FOREIGN KEY (package\_category\_id) REFERENCES Tagms.package\_category(package\_category\_id)
);

CREATE TABLE Tagms.lot (
lot\_id SERIAL PRIMARY KEY,
expiration\_date TIMESTAMP WITH TIME ZONE NOT NULL,
product\_id INTEGER NOT NULL,
product\_quantity Tagms.quantity,
package\_id INTEGER NOT NULL,
package\_quantity Tagms.quantity,
lot\_discount Tagms.percentage  NOT NULL,
vat Tagms.percentage NOT NULL,
lot\_price Tagms.price,
FOREIGN KEY (package\_id) REFERENCES Tagms.package(package\_id),
FOREIGN KEY (product\_id) REFERENCES Tagms.product(product\_id)
);

CREATE TABLE Tagms.made\_up\_of\_1 (
product\_id INTEGER,
item\_id INTEGER,
quantity Tagms.quantity,
FOREIGN KEY (product\_id) REFERENCES Tagms.product(product\_id),
FOREIGN KEY (item\_id) REFERENCES Tagms.item(item\_id),
PRIMARY KEY (product\_id, item\_id)
);

CREATE TABLE Tagms.made\_up\_of\_2 (
package\_id INTEGER,
item\_id INTEGER,
quantity Tagms.quantity,
FOREIGN KEY (package\_id) REFERENCES Tagms.package(package\_id),
FOREIGN KEY (item\_id) REFERENCES Tagms.item(item\_id),
PRIMARY KEY (package\_id, item\_id)
);

CREATE TABLE Tagms.customer (
vat\_number Tagms.vatnumber PRIMARY KEY,
customer\_name VARCHAR(50) NOT NULL,
phone\_number Tagms.phonenumber NOT NULL,
address VARCHAR(100) NOT NULL,
email\_address Tagms.emailaddress NOT NULL,
registration\_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT\_TIMESTAMP
);

CREATE TABLE Tagms.role (
role\_id SMALLSERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500)
);

CREATE TABLE Tagms.employee (
tax\_number Tagms.taxnumber PRIMARY KEY,
first\_name VARCHAR(30) NOT NULL,
last\_name VARCHAR(30) NOT NULL,
phone\_number Tagms.phonenumber NOT NULL,
email\_address Tagms.emailaddress NOT NULL,
birth\_date DATE,
hiring\_date DATE NOT NULL,
still\_working BOOLEAN NOT NULL,
role\_id SMALLINT NOT NULL,
FOREIGN KEY (role\_id) REFERENCES Tagms.role(role\_id)
);

CREATE TABLE Tagms.department (
department\_id SMALLSERIAL PRIMARY KEY,
name VARCHAR(30) NOT NULL,
description VARCHAR(500)
);

CREATE TABLE Tagms.work (
department\_id SMALLINT,
employee\_id Tagms.taxnumber,
FOREIGN KEY (department\_id) REFERENCES Tagms.department(department\_id),
FOREIGN KEY (employee\_id) REFERENCES Tagms.employee(tax\_number),
PRIMARY KEY (department\_id, employee\_id)
);

CREATE TABLE Tagms.supplier (
vat\_number Tagms.vatnumber PRIMARY KEY,
supplier\_name VARCHAR(50) NOT NULL,
phone\_number Tagms.phonenumber NOT NULL,
email\_address Tagms.emailaddress NOT NULL,
address VARCHAR(100) NOT NULL,
registration\_date DATE NOT NULL
);

CREATE TABLE Tagms.contract (
contract\_id SERIAL PRIMARY KEY,
description VARCHAR(500),
contract\_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT\_TIMESTAMP,
delivery\_date TIMESTAMP WITH TIME ZONE NOT NULL,
expiration\_date TIMESTAMP WITH TIME ZONE NOT NULL,
supplier\_id Tagms.vatnumber NOT NULL,
employee\_id Tagms.taxnumber NOT NULL,
FOREIGN KEY (supplier\_id) REFERENCES Tagms.supplier(vat\_number),
FOREIGN KEY (employee\_id) REFERENCES Tagms.employee(tax\_number)
);

CREATE TABLE Tagms.specify (
item\_id INTEGER,
contract\_id INTEGER,
price Tagms.price,
purchased\_quantity Tagms.quantity,
FOREIGN KEY (item\_id) REFERENCES Tagms.item(item\_id),
FOREIGN KEY (contract\_id) REFERENCES Tagms.contract(contract\_id),
PRIMARY KEY (item\_id, contract\_id)
);

CREATE TABLE Tagms.order (
order\_id SERIAL PRIMARY KEY,
net\_price Tagms.price,
taxes Tagms.price,
order\_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT\_TIMESTAMP,
order\_paid BOOLEAN NOT NULL,
employee\_id Tagms.taxnumber NOT NULL,
customer\_id Tagms.vatnumber NOT NULL,
FOREIGN KEY (employee\_id) REFERENCES Tagms.employee(tax\_number),
FOREIGN KEY (customer\_id) REFERENCES Tagms.customer(vat\_number)
);

CREATE TABLE Tagms.draws\_from (
lot_id INTEGER PRIMARY KEY,
order\_id INTEGER NOT NULL,
FOREIGN KEY (lot\_id) REFERENCES Tagms.lot(lot\_id),
FOREIGN KEY (order\_id) REFERENCES Tagms.order(order\_id)
);

CREATE TABLE Tagms.ship (
order\_id INTEGER PRIMARY KEY,
employee\_id Tagms.taxnumber NOT NULL,
shipping\_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT\_TIMESTAMP,
track\_num Tagms.tracknum,
FOREIGN KEY (order\_id) REFERENCES Tagms.order(order\_id),
FOREIGN KEY (employee\_id) REFERENCES Tagms.employee(tax\_number)
);

\end{lstlisting}