\section{Principal Queries}
\textcolor{red}{[Write some of the queries to be performed to satisfy your functional requirements. 3-4 queries are enough, try to use the techniques seen at lecture (aggregate functions, group by, subqueries,â€¦)]}

\begin{lstlisting}[language=SQL,
keywordstyle=\color{blue},
stringstyle=\color{mauve},
showstringspaces=false,
basicstyle=\ttfamily\footnotesize]
SELECT t1.attr1
FROM table1 as t1
    LEFT JOIN table2 as t2 ON t1.attr2=t2.attr1 
WHERE t1.attr3=1

-- list all contracts between a certain manager and a certain supplier
select c.description,c.contract\_date,c.expiration\_date,e.first\_name as manager\_name,e.last\_name as manager\_surname
		from tagms.contract as c inner join tagms.employee as e on
        c.employee\_id=e.tax\_number inner join tagms.supplier as s on
        c.supplier\_id=s.vat\_number where e.tax\_number='FGDVSF30C62D012T' and
        s.supplier\_name='Reg s.r.l.';

-- list all outbound transactions sorted from most to least amount of money:
select tagms.order.* from tagms.order order by tagms.order.net\_price DESC;

-- list all inbound transactions sorted from most to least amount of money:
select tagms.specify.* from tagms.specify order by tagms.specify.price DESC;

-- Show all the details of the employees in the organization

select tagms.employee.*, tagms.department.name from tagms.employee inner join tagms.work on
        tagms.employee.tax\_number=tagms.work.employee\_id inner join tagms.department on
        tagms.work.department\_id=tagms.department.department\_id where tagms.employee.still\_working=TRUE;

-- TODO: Explain briefly the principal queries

-- After inserting a new lot with identifier Lot\_id (see the "populate" section)
-- decrease the quantity of the items involved in the production of a lot
-- Note: it is necessary to insert the Lot\_id twice in the query

UPDATE tagms.item AS i SET
    quantity = c.quantity
FROM (
    SELECT i.item\_id, i.quantity - l.product\_quantity * m1.quantity AS quantity FROM tagms.lot AS l
        INNER JOIN tagms.made\_up\_of\_1 AS m1 ON l.product\_id = m1.product\_id
        INNER JOIN tagms.item AS i ON m1.item\_id = i.item\_id
    UNION
    SELECT i.item\_id, i.quantity - l.package\_quantity * m2.quantity AS quantity FROM tagms.lot AS l
        INNER JOIN tagms.made\_up\_of\_2 AS m2 ON l.package\_id = m2.package\_id
        INNER JOIN tagms.item AS i ON m2.item\_id = i.item\_id
    WHERE l.lot\_id = '3'
    ORDER BY item\_id ASC
     )
         AS c(item\_id, quantity)
WHERE c.item\_id = i.item\_id
RETURNING i.item\_id, name, description, i.quantity, minimum\_quantity, item\_category\_id;



-- After inserting a new contract with identifier Contract\_id,
-- in the delivery date the quantities of items in stock must be incremented

UPDATE tagms.item AS i SET
    quantity = c.quantity
FROM (
    SELECT i.item\_id, i.quantity + s.purchased\_quantity AS quantity FROM tagms.contract AS c
        INNER JOIN tagms.specify AS s ON c.contract\_id = s.contract\_id
        INNER JOIN tagms.item AS i ON s.item\_id = i.item\_id
    WHERE c.contract\_id = '4'
     )
     AS c(item\_id, quantity)
WHERE c.item\_id = i.item\_id
RETURNING i.item\_id, name, description, i.quantity, minimum\_quantity, item\_category\_id;



-- Lists all available lots (unsold and that won't expire in 6 months) containing
-- a particular product having a given Product\_id as identifier,
-- sorted by expiration date (oldest lots must be sold first).

SELECT l.lot\_id,
       DATE(l.expiration\_date) AS expiration\_date,
       l.product\_id,
       l.product\_quantity,
       ROUND(l.lot\_price * (1 + l.vat/100) * (1 - l.lot\_discount/100), 2) AS gross\_price
FROM tagms.lot AS l
    LEFT OUTER JOIN tagms.draws\_from AS df ON l.lot\_id = df.lot\_id
WHERE l.product\_id = '6'
  AND l.expiration\_date > (current\_date + interval '6 months')
  AND df.order\_id IS NULL
ORDER BY l.expiration\_date ASC;


-- Get the net sales and paid taxes in a given time interval
SELECT SUM(o.net\_price) AS net\_sales, SUM(o.taxes) AS taxes FROM tagms.order AS o
    WHERE DATE(o.order\_date) >= '2021-01-01' AND
          DATE(o.order\_date) <= '2021-12-31' AND
          o.order\_paid = TRUE;

-- Get the cost of materials in a given time interval
SELECT SUM(sp.price) AS cost\_of\_material FROM tagms.specify as sp
    INNER JOIN tagms.contract AS c ON c.contract\_id = sp.contract\_id
WHERE DATE(c.contract\_date) >= '2021-01-01' AND DATE(c.contract\_date) <= '2021-12-31';

-- Get the production cost in a given time interval
SELECT SUM(p.production\_cost * l.product\_quantity) AS production\_cost FROM tagms.lot AS l
    JOIN tagms.product AS p ON l.product\_id = p.product\_id
    JOIN tagms.draws\_from AS df ON l.lot\_id = df.lot\_id
    JOIN tagms.order AS o ON df.order\_id = o.order\_id
WHERE DATE(o.order\_date) >= '2021-01-01' AND DATE(o.order\_date) <= '2021-12-31';

-- Note: BETWEEN was not used as it makes a strict comparison (extremes excluded)


-- When inserting an order, the operator can choose a custom price (e.g., decided with the customer)
-- or use the following query.
-- Given an order with Order\_id, compute the order's net\_price and total taxes.
-- Note: the given Order\_id must be written twice in the query

UPDATE tagms.order AS o
SET net\_price = tmp.net\_price,
    taxes = tmp.taxes
FROM (
         SELECT SUM(l.lot\_price * (1 - l.lot\_discount / 100)) AS net\_price,
                SUM(l.lot\_price * l.VAT/100) as taxes
         FROM tagms.draws\_from AS df
                  INNER JOIN tagms.lot AS l ON df.lot\_id = l.lot\_id
        WHERE df.order\_id = '2'
    ) AS tmp(net\_price, taxes)
WHERE o.order\_id = '2'
RETURNING o.order\_id, o.net\_price, o.taxes;


-- When inserting a lot, the operator can choose a custom price
-- or use the following query.
-- Given a lot with Lot\_id, compute the lot price
-- Note: the given Lot\_id must be written twice in the query

UPDATE tagms.lot AS l
SET lot\_price = tmp.lot\_price
FROM (
         SELECT p.production\_cost*p.price\_increase*l.product\_quantity
             AS lot\_price FROM tagms.lot AS l
            INNER JOIN tagms.product AS p ON l.product\_id = p.product\_id
         WHERE l.lot\_id = '3'
     ) AS tmp(lot\_price)
WHERE l.lot\_id = '3'
RETURNING *;


-- Given an item (which is used to create a product) having Item\_id as identifier
-- and a time interval (actually, two dates),
-- find the total quantity of that item that has been used for production or packaging during that time.

SELECT SUM(l.product\_quantity * m1.quantity) AS quantity FROM tagms.made\_up\_of\_1 AS m1
    INNER JOIN tagms.lot AS l ON m1.product\_id = l.product\_id
    INNER JOIN tagms.draws\_from AS df ON l.lot\_id = df.lot\_id
    INNER JOIN tagms.order AS o ON df.order\_id = o.order\_id
WHERE m1.item\_id = '9'
  AND DATE(o.order\_date) >= '2021-01-01'
  AND DATE(o.order\_date) <= '2021-12-31';

/*
SELECT SUM(l.product\_quantity * m.quantity) AS quantity FROM
    (
            SELECT * FROM tagms.made\_up\_of\_1 AS m1
        UNION
            SELECT * FROM tagms.made\_up\_of\_2 AS m2
    )
    AS m(product\_id, item\_id, quantity)
    INNER JOIN tagms.lot AS l ON m.product\_id = l.product\_id
    INNER JOIN tagms.draws\_from AS df ON l.lot\_id = df.lot\_id
    INNER JOIN tagms.order AS o ON df.order\_id = o.order\_id
WHERE m.item\_id = '8'
  AND DATE(o.order\_date) >= '2021-01-01'
  AND DATE(o.order\_date) <= '2021-12-31';
 */

SELECT * FROM tagms.item AS i
WHERE i.quantity < i.minimum\_quantity;

-- Return the list of unsellable lots which are in stock (that will expire in less than 6 months)
SELECT * FROM tagms.lot AS l
    LEFT OUTER JOIN tagms.draws\_from AS df ON l.lot\_id = df.lot\_id
WHERE l.expiration\_date <= (current\_date + interval '6 months')
  AND df.order\_id IS NULL;

\end{lstlisting}

